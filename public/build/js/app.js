let paso=1;const pasoInicial=1,pasoFinal=4,cita={id:"",name:"",hora:"",fecha:"",servicios:[]};function iniciarApp(){mostrarSeccion(),tabs(),paginador(),siguiente(),anterior(),consultarAPI(),idCliente(),nombreCliente(),seleccionarFecha(),buscarHorasDisponibles(),mostrarResumen(),reservarCita(),cargarMisCitas(),mostrarMisCitas()}function mostrarSeccion(){const e=document.querySelector(".mostrar");e&&e.classList.remove("mostrar");const t="#paso-"+paso;document.querySelector(t).classList.add("mostrar");const n=document.querySelector(".actual");n&&n.classList.remove("actual");document.querySelector(`[data-paso="${paso}"]`).classList.add("actual")}function tabs(){document.querySelectorAll(".tabs button").forEach((function(e){return e.addEventListener("click",(function(e){paso=parseInt(e.target.dataset.paso),mostrarSeccion(),paginador()}))}))}function paginador(){const e=document.querySelector("#anterior"),t=document.querySelector("#siguiente");1===paso?(e.classList.add("ocultar"),t.classList.remove("ocultar")):4===paso?(e.classList.remove("ocultar"),t.classList.add("ocultar")):(e.classList.remove("ocultar"),t.classList.remove("ocultar")),mostrarResumen(),mostrarSeccion()}function anterior(){document.querySelector("#anterior").addEventListener("click",(function(){paso<=1||(paso--,paginador())}))}function siguiente(){document.querySelector("#siguiente").addEventListener("click",(function(){paso>=4||(paso++,paginador())}))}async function consultarAPI(){try{const e="/api/servicios",t=await fetch(e);mostrarServicios(await t.json())}catch(e){console.log(e)}}function mostrarServicios(e){e.filter((function(e){return"1"!==e.eliminada})).forEach((function(e){const{id:t,name:n,price:a}=e,o=document.createElement("P");o.classList.add("nombre-servicio"),o.textContent=n;const r=document.createElement("P");r.classList.add("precio-servicio"),r.textContent=""+a;const c=document.createElement("DIV");c.classList.add("servicio"),c.dataset.idServicio=t,c.onclick=function(){seleccionarServicio(e)},c.appendChild(o),c.appendChild(r),document.querySelector("#servicios").appendChild(c)}))}function seleccionarServicio(e){const{id:t}=e,{servicios:n}=cita,a=document.querySelector(`[data-id-servicio="${t}"]`);if(n.some((function(e){return e.id===t})))cita.servicios=n.filter((function(e){return e.id!==t})),a.classList.remove("seleccionado");else{if(n.length>0)return void alert("Solo puedes tomar un servicio a la vez");cita.servicios=[...n,e],a.classList.add("seleccionado")}}function idCliente(){cita.id=document.querySelector("#id").value}function nombreCliente(){cita.name=document.querySelector("#nombre").value}function seleccionarFecha(){document.querySelector("#fecha").addEventListener("change",buscarHorasDisponibles)}async function buscarHorasDisponibles(e){if(!e)return;const t=e.target.value,n=new Date(t).getUTCDay();try{const a="/api/citasPorFecha?fecha="+t,o=await fetch(a),r=await o.json();if([6].includes(n))mostrarAlerta("Los s√°bados trabajamos de 10:00 AM a 2:00 PM","warning",".form"),cita.fecha=t;else{if([0].includes(n))return mostrarAlerta("Los domingos no trabajamos","error",".form"),document.getElementById("fecha").value="",document.getElementById("lista-horas").style.display="none",void(document.getElementById("hora-placeholder").style.display="inline-block");if(n<new Date)return mostrarAlerta("No se permite seleccionar fecha anterior al dia de hoy","error",".form"),document.getElementById("fecha").value="",document.getElementById("lista-horas").style.display="none",void(document.getElementById("hora-placeholder").style.display="inline-block")}mostrarHorasDisponibles(r.horas_disponibles),cita.fecha=e.target.value}catch(e){console.log(e)}}function mostrarHorasDisponibles(e){const t=document.getElementById("lista-horas"),n=document.getElementById("hora-placeholder");t.innerHTML="",e.forEach((function(e){const n=document.createElement("option");n.value=e,n.textContent=e,t.appendChild(n)})),t.style.display="block",n.style.display="none",t.addEventListener("change",(function(e){cita.hora=e.target.value}))}function mostrarAlerta(e,t,n,a=!0){const o=document.querySelector(".alerta");o&&o.remove();const r=document.createElement("DIV");r.textContent=e,r.classList.add("alerta"),r.classList.add(t);document.querySelector(n).appendChild(r),a&&(setTimeout((function(){r.classList.add("desvanecer")}),3e3),r.addEventListener("transitionend",(function(){r.remove()})))}function mostrarResumen(){const e=document.querySelector(".contenido-resumen");for(;e.firstChild;)e.removeChild(e.firstChild);if(Object.values(cita).includes("")||0===cita.servicios.length)return void mostrarAlerta("Hacen falta datos","error",".contenido-resumen",!1);const{name:t,fecha:n,hora:a,servicios:o}=cita,r=document.createElement("H3");r.textContent="Resumen de cita",e.appendChild(r),o.forEach((function(t){const{price:n,name:a}=t,o=document.createElement("DIV");o.classList.add("contenedor-servico");const r=document.createElement("P");r.textContent=a;const c=document.createElement("P");c.innerHTML="<span>Precio: </span>"+n,o.appendChild(r),o.appendChild(c),e.appendChild(o)}));const c=document.createElement("P");c.innerHTML="<span>Nombre:</span>"+t;const i=new Date(n),s=i.getMonth(),l=i.getDate()+2,d=i.getFullYear(),u=new Date(Date.UTC(d,s,l)).toLocaleDateString("es-ES",{weekday:"long",year:"numeric",month:"long",day:"numeric"}),m=document.createElement("P");m.innerHTML="<span>Fecha: </span>"+u;const p=document.createElement("P");p.innerHTML="<span>Hora: </span>"+a;const f=document.createElement("BUTTON");f.classList.add("boton"),f.textContent="Reservar Cita",f.onclick=reservarCita,e.appendChild(m),e.appendChild(p),e.appendChild(c),e.appendChild(f)}async function reservarCita(){const{name:e,servicios:t,fecha:n,hora:a,id:o}=cita,r=t.map((function(e){return e.id}));if(o&&e&&n&&a&&0!==t.length)try{const e=`/api/citaDisponible?fecha=${n}&hora=${a.includes(":")?a+":00":a+":00:00"}`;if((await fetch(e)).ok){const e=new FormData;e.append("fecha",n),e.append("hora",a),e.append("userId",o),e.append("servicioId",r);try{const t="/api/citas",n=await fetch(t,{method:"POST",body:e});(await n.json()).resultado&&Swal.fire({icon:"success",title:"Cita Creada",text:"Tu cita fue creada correctamente",button:"OK"}).then((function(){setTimeout((function(){window.location.reload()}),1e3)}))}catch(e){console.log(e),Swal.fire({icon:"error",title:"Error",text:"Hubo un error al guardar la cita"})}}else Swal.fire({icon:"error",title:"Error",text:"Fecha y hora no disponible"})}catch(e){return console.log(e),void mostrarAlerta("Hubo un error al verificar la disponibilidad de la cita","error",".form")}else mostrarAlerta("Faltan datos","error",".contenido-resumen",!1)}async function cargarMisCitas(){try{const e="/api/citas/mis-citas",t=await fetch(e),n=await t.json();n.sort((function(e,t){return new Date(e.fecha)-new Date(t.fecha)})),mostrarMisCitas(n)}catch(e){console.log(e),mostrarAlerta("Hubo un error al cargar tus citas","error",".form")}}function mostrarMisCitas(e){const t=document.getElementById("lista-citas");if(t.innerHTML="",0===e.length){const e=document.createElement("p");return e.textContent="No tienes citas programadas",void t.appendChild(e)}e.filter((function(e){return"1"!==e.eliminada})).forEach((function(e){const{servicio:t,precio:n,fecha:a,hora:o}=e,r=new Date(a);if(r<new Date)return;const c=r.getMonth(),i=r.getDate()+2,s=r.getFullYear(),l=new Date(Date.UTC(s,c,i)).toLocaleDateString("es-ES",{weekday:"long",year:"numeric",month:"long",day:"numeric"}),d=document.createElement("P");d.classList.add("nombre-servicio"),d.textContent=l;const u=document.createElement("P");u.classList.add("nombre-servicio"),u.textContent=o;const m=document.createElement("P");m.classList.add("nombre-servicio"),m.textContent=t;const p=document.createElement("P");p.classList.add("precio-cita"),p.textContent=""+n;const f=document.createElement("DIV");f.classList.add("servicio"),f.dataset.idServicio=id,f.appendChild(m),f.appendChild(u),f.appendChild(d),f.appendChild(p),document.querySelector("#lista-citas").appendChild(f)}))}document.addEventListener("DOMContentLoaded",(function(){iniciarApp()}));